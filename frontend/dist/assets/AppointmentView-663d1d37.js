import{d as Ee,u as Ne,r as m,a as h,b as d,G as Ie,o as i,c as b,e as l,w as a,f as U,F as N,D as q,j as I,k as A,g as c,i as P,I as Ae,t as S,E as ee,_ as Te}from"./index-459586b0.js";import{r as x}from"./request-51dbdc85.js";import{g as we}from"./doctor-b032f4ea.js";function Pe(g){return x.get("/api/appointments/page",{params:g})}function Re(g){return x.post("/api/appointments",g)}function te(g,o,p){return x.put(`/api/appointments/${g}/status`,null,{params:{status:o,remark:p}})}function Ue(g,o){return x.put(`/api/appointments/${g}/cancel`,null,{params:{remark:o}})}const Se={class:"appointment-container"},xe={class:"card-header"},ze={class:"pagination"},Oe=Ee({__name:"AppointmentView",setup(g){var J,H,K,Q,W;const o=Ne(),p=m(!1),j=m(0),B=m([]),T=m(!1),y=m(!1),z=m(),G=m([]),f=m(""),V=m(),k=m(""),C=m("approve"),le=["内科","外科","妇产科","儿科","眼科","耳鼻喉科","口腔科","皮肤科","精神科","中医科"],F={PENDING:"待审核",APPROVED:"已通过",REJECTED:"已拒绝",CANCELLED:"已取消",COMPLETED:"已完成"},u=h({current:1,size:10,status:"",patientId:((J=o.user)==null?void 0:J.role)==="USER"?(H=o.user)==null?void 0:H.id:void 0,doctorId:((K=o.user)==null?void 0:K.role)==="DOCTOR"?(Q=o.user)==null?void 0:Q.id:void 0,patientName:"",doctorName:""}),r=h({patientId:(W=o.user)==null?void 0:W.id,doctorId:void 0,appointmentTime:"",description:"",department:""}),ae={department:[{required:!0,message:"请选择科室",trigger:"change"}],doctorId:[{required:!0,message:"请选择医生",trigger:"change"}],appointmentTime:[{required:!0,message:"请选择预约时间",trigger:"change"}],description:[{required:!0,message:"请输入就诊描述",trigger:"blur"}]},ne=n=>({PENDING:"warning",APPROVED:"success",REJECTED:"danger",CANCELLED:"info",COMPLETED:""})[n],D=async()=>{try{p.value=!0;const n=await Pe(u);B.value=n.data.records,j.value=n.data.total}finally{p.value=!1}},oe=()=>{u.current=1,D()},re=n=>{u.size=n,D()},ue=n=>{u.current=n,D()},se=async()=>{if(!r.department)return;const n=await we({current:1,size:100,department:r.department});G.value=n.data.records},de=()=>{var n;Object.assign(r,{patientId:(n=o.user)==null?void 0:n.id,doctorId:void 0,appointmentTime:"",description:"",department:""}),T.value=!0},ie=async()=>{if(z.value){await z.value.validate();try{p.value=!0;const n={patientId:r.patientId,doctorId:r.doctorId,appointmentTime:r.appointmentTime,description:r.description};await Re(n),ee.success("预约成功"),T.value=!1,D()}finally{p.value=!1}}},pe=n=>{V.value=n,k.value="通过预约",C.value="approve",f.value="",y.value=!0},me=n=>{V.value=n,k.value="拒绝预约",C.value="reject",f.value="",y.value=!0},ce=n=>{V.value=n,k.value="取消预约",C.value="cancel",f.value="",y.value=!0},ve=n=>{V.value=n,k.value="完成预约",C.value="approve",f.value="",y.value=!0},fe=async()=>{if(V.value)try{p.value=!0,C.value==="cancel"?await Ue(V.value.id,f.value):k.value==="完成预约"?await te(V.value.id,"COMPLETED",f.value):await te(V.value.id,C.value==="approve"?"APPROVED":"REJECTED",f.value),ee.success("操作成功"),y.value=!1,D()}finally{p.value=!1}},_e=n=>n.getTime()<Date.now()-864e5,ge=()=>Array.from({length:24},(n,e)=>e).filter(n=>n<8||n>17);return D(),(n,e)=>{const O=d("el-option"),M=d("el-select"),_=d("el-form-item"),R=d("el-input"),v=d("el-button"),L=d("el-form"),E=d("el-table-column"),ye=d("el-tag"),Ve=d("el-table"),be=d("el-pagination"),ke=d("el-card"),Ce=d("el-date-picker"),X=d("el-dialog"),De=Ie("loading");return i(),b("div",Se,[l(ke,null,{header:a(()=>[U("div",xe,[l(L,{inline:!0,model:u},{default:a(()=>{var t;return[l(_,null,{default:a(()=>[l(M,{modelValue:u.status,"onUpdate:modelValue":e[0]||(e[0]=s=>u.status=s),placeholder:"状态",clearable:""},{default:a(()=>[(i(),b(N,null,q(F,(s,w)=>l(O,{key:w,label:s,value:w},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),((t=I(o).user)==null?void 0:t.role)==="ADMIN"?(i(),b(N,{key:0},[l(_,null,{default:a(()=>[l(R,{modelValue:u.patientName,"onUpdate:modelValue":e[1]||(e[1]=s=>u.patientName=s),placeholder:"患者姓名",clearable:""},null,8,["modelValue"])]),_:1}),l(_,null,{default:a(()=>[l(R,{modelValue:u.doctorName,"onUpdate:modelValue":e[2]||(e[2]=s=>u.doctorName=s),placeholder:"医生姓名",clearable:""},null,8,["modelValue"])]),_:1})],64)):A("",!0),l(_,null,{default:a(()=>{var s;return[l(v,{type:"primary",onClick:oe},{default:a(()=>e[14]||(e[14]=[c("搜索")])),_:1,__:[14]}),((s=I(o).user)==null?void 0:s.role)==="USER"?(i(),P(v,{key:0,type:"success",onClick:de},{default:a(()=>e[15]||(e[15]=[c(" 预约挂号 ")])),_:1,__:[15]})):A("",!0)]}),_:1})]}),_:1},8,["model"])])]),default:a(()=>[Ae((i(),P(Ve,{data:B.value,border:"",style:{width:"100%"}},{default:a(()=>[l(E,{prop:"appointmentTime",label:"预约时间"}),l(E,{label:"医生信息"},{default:a(({row:t})=>[U("div",null,S(t.doctorName),1),U("div",null,S(t.department)+" - "+S(t.title),1)]),_:1}),l(E,{prop:"description",label:"就诊描述","show-overflow-tooltip":""}),l(E,{prop:"status",label:"状态"},{default:a(({row:t})=>[l(ye,{type:ne(t.status)},{default:a(()=>[c(S(F[t.status]),1)]),_:2},1032,["type"])]),_:1}),l(E,{prop:"remark",label:"备注","show-overflow-tooltip":""}),l(E,{label:"操作",width:"200"},{default:a(({row:t})=>{var s,w,Y,Z;return[t.status==="PENDING"?(i(),b(N,{key:0},[((s=I(o).user)==null?void 0:s.role)==="DOCTOR"||((w=I(o).user)==null?void 0:w.role)==="ADMIN"?(i(),b(N,{key:0},[l(v,{type:"success",link:"",onClick:$=>pe(t)},{default:a(()=>e[16]||(e[16]=[c(" 通过 ")])),_:2,__:[16]},1032,["onClick"]),l(v,{type:"danger",link:"",onClick:$=>me(t)},{default:a(()=>e[17]||(e[17]=[c(" 拒绝 ")])),_:2,__:[17]},1032,["onClick"])],64)):A("",!0),((Y=I(o).user)==null?void 0:Y.role)==="USER"?(i(),P(v,{key:1,type:"danger",link:"",onClick:$=>ce(t)},{default:a(()=>e[18]||(e[18]=[c(" 取消 ")])),_:2,__:[18]},1032,["onClick"])):A("",!0)],64)):A("",!0),t.status==="APPROVED"&&((Z=I(o).user)==null?void 0:Z.role)==="ADMIN"?(i(),P(v,{key:1,type:"primary",link:"",onClick:$=>ve(t)},{default:a(()=>e[19]||(e[19]=[c(" 完成 ")])),_:2,__:[19]},1032,["onClick"])):A("",!0)]}),_:1})]),_:1},8,["data"])),[[De,p.value]]),U("div",ze,[l(be,{"current-page":u.current,"onUpdate:currentPage":e[3]||(e[3]=t=>u.current=t),"page-size":u.size,"onUpdate:pageSize":e[4]||(e[4]=t=>u.size=t),"page-sizes":[10,20,50],total:j.value,layout:"total, sizes, prev, pager, next",onSizeChange:re,onCurrentChange:ue},null,8,["current-page","page-size","total"])])]),_:1}),l(X,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=t=>T.value=t),title:"预约挂号",width:"500px"},{footer:a(()=>[l(v,{onClick:e[9]||(e[9]=t=>T.value=!1)},{default:a(()=>e[20]||(e[20]=[c("取消")])),_:1,__:[20]}),l(v,{type:"primary",onClick:ie,loading:p.value},{default:a(()=>e[21]||(e[21]=[c(" 确定 ")])),_:1,__:[21]},8,["loading"])]),default:a(()=>[l(L,{ref_key:"formRef",ref:z,model:r,rules:ae,"label-width":"100px"},{default:a(()=>[l(_,{label:"科室",prop:"department"},{default:a(()=>[l(M,{modelValue:r.department,"onUpdate:modelValue":e[5]||(e[5]=t=>r.department=t),placeholder:"请选择科室",onChange:se},{default:a(()=>[(i(),b(N,null,q(le,t=>l(O,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"医生",prop:"doctorId"},{default:a(()=>[l(M,{modelValue:r.doctorId,"onUpdate:modelValue":e[6]||(e[6]=t=>r.doctorId=t),placeholder:"请选择医生"},{default:a(()=>[(i(!0),b(N,null,q(G.value,t=>(i(),P(O,{key:t.id,label:t.realName,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"预约时间",prop:"appointmentTime"},{default:a(()=>[l(Ce,{modelValue:r.appointmentTime,"onUpdate:modelValue":e[7]||(e[7]=t=>r.appointmentTime=t),type:"datetime",placeholder:"请选择预约时间","disabled-date":_e,"disabled-hours":ge},null,8,["modelValue"])]),_:1}),l(_,{label:"就诊描述",prop:"description"},{default:a(()=>[l(R,{modelValue:r.description,"onUpdate:modelValue":e[8]||(e[8]=t=>r.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(X,{modelValue:y.value,"onUpdate:modelValue":e[13]||(e[13]=t=>y.value=t),title:k.value,width:"400px"},{footer:a(()=>[l(v,{onClick:e[12]||(e[12]=t=>y.value=!1)},{default:a(()=>e[22]||(e[22]=[c("取消")])),_:1,__:[22]}),l(v,{type:"primary",onClick:fe,loading:p.value},{default:a(()=>e[23]||(e[23]=[c(" 确定 ")])),_:1,__:[23]},8,["loading"])]),default:a(()=>[l(L,null,{default:a(()=>[l(_,{label:"备注","label-width":"100px"},{default:a(()=>[l(R,{modelValue:f.value,"onUpdate:modelValue":e[11]||(e[11]=t=>f.value=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}});const qe=Te(Oe,[["__scopeId","data-v-3a9f2947"]]);export{qe as default};
