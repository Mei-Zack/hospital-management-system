import{g as fe,j as _e,k as be,l as ge,r as ve}from"./medicine-c36ad563.js";import{d as ye,u as Ve,a as h,r as _,K as we,B as Ne,b as u,G as ke,o as V,c as M,e,w as a,f as G,g as d,F as J,D as K,I as Ce,i as S,t as s,k as De,E as H,J as Ie,_ as Se}from"./index-459586b0.js";import"./request-51dbdc85.js";const Ue={class:"sale-container"},qe={class:"card-header"},Te=ye({__name:"SaleView",setup(xe){var O,L;const w=Ve(),r=h({current:1,size:10,saleNumber:"",medicineId:void 0,patientName:"",startDate:void 0,endDate:void 0}),g=_(null);we(()=>(g.value?(r.startDate=g.value[0],r.endDate=g.value[1]):(r.startDate=void 0,r.endDate=void 0),g.value));const U=_(!1),q=_([]),T=_(0),N=_([]),k=_(!1),z=_(""),x=_(!1),C=_(),n=h({saleNumber:"",medicineId:void 0,batchNumber:"",quantity:1,unit:"",salePrice:0,totalAmount:0,patientName:"",saleTime:new Date().toISOString().slice(0,19).replace("T"," "),operatorId:(O=w.user)==null?void 0:O.id,operatorName:(L=w.user)==null?void 0:L.realName,status:1,remark:""}),W={medicineId:[{required:!0,message:"请选择药品",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"}],unit:[{required:!0,message:"请输入单位",trigger:"blur"}],salePrice:[{required:!0,message:"请输入售价",trigger:"blur"}],patientName:[{required:!0,message:"请输入患者姓名",trigger:"blur"}],saleTime:[{required:!0,message:"请选择销售时间",trigger:"change"}]},D=_(!1),i=h({});Ne(()=>{X(),v()});const X=async()=>{try{const o=await fe({current:1,size:1e3});o.data&&Array.isArray(o.data.records)?N.value=o.data.records:(N.value=[],console.error("获取药品列表返回的数据格式不正确",o.data))}catch(o){console.error("获取药品列表失败",o)}},v=async()=>{U.value=!0;try{const o=await _e({...r,startDate:r.startDate,endDate:r.endDate});o.data&&Array.isArray(o.data.records)?(q.value=o.data.records,T.value=o.data.total||0):(q.value=[],T.value=0,console.error("获取销售记录返回的数据格式不正确",o.data))}catch(o){console.error("获取销售记录失败",o)}finally{U.value=!1}},Z=()=>{r.current=1,v()},ee=()=>{r.current=1,r.medicineId=void 0,r.saleNumber="",r.patientName="",g.value=null,r.startDate=void 0,r.endDate=void 0,v()},le=o=>{r.size=o,v()},ae=o=>{r.current=o,v()},A=o=>{const l=N.value.find(p=>p.id===o);return l?l.name:""},te=o=>{const l=N.value.find(p=>p.id===o);l&&(n.unit=l.unit||"",n.salePrice=l.salePrice,P())},P=()=>{n.quantity&&n.salePrice&&(n.totalAmount=n.quantity*n.salePrice)},oe=()=>{var o,l;z.value="新增销售",k.value=!0,B(),n.saleTime=new Date().toISOString().slice(0,19).replace("T"," "),n.operatorId=(o=w.user)==null?void 0:o.id,n.operatorName=(l=w.user)==null?void 0:l.realName},ne=o=>{be(o.id).then(l=>{Object.assign(i,l.data),D.value=!0})},B=()=>{var o,l;C.value&&C.value.resetFields(),Object.assign(n,{saleNumber:"",medicineId:void 0,batchNumber:"",quantity:1,unit:"",salePrice:0,totalAmount:0,patientName:"",saleTime:new Date().toISOString().slice(0,19).replace("T"," "),operatorId:(o=w.user)==null?void 0:o.id,operatorName:(l=w.user)==null?void 0:l.realName,status:1,remark:""})},re=async()=>{C.value&&await C.value.validate(async o=>{if(o){x.value=!0;try{await ge(n),H.success("销售成功"),k.value=!1,v()}catch(l){console.error("销售失败",l)}finally{x.value=!1}}})},de=o=>{Ie.confirm("确定要退货吗？退货后将增加对应药品的库存","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ve(o.id),H.success("退货成功"),v()}catch(l){console.error("退货失败",l)}}).catch(()=>{})};return(o,l)=>{const p=u("el-button"),y=u("el-input"),m=u("el-form-item"),F=u("el-option"),j=u("el-select"),E=u("el-date-picker"),R=u("el-form"),c=u("el-table-column"),Y=u("el-tag"),ue=u("el-table"),ie=u("el-pagination"),se=u("el-card"),b=u("el-col"),I=u("el-row"),$=u("el-input-number"),Q=u("el-dialog"),f=u("el-descriptions-item"),me=u("el-descriptions"),pe=ke("loading");return V(),M("div",Ue,[e(se,{class:"sale-card"},{header:a(()=>[G("div",qe,[l[20]||(l[20]=G("h3",null,"药品销售管理",-1)),e(p,{type:"primary",onClick:oe},{default:a(()=>l[19]||(l[19]=[d("新增销售")])),_:1,__:[19]})])]),default:a(()=>[e(R,{inline:!0,model:r,class:"search-form"},{default:a(()=>[e(m,{label:"销售单号"},{default:a(()=>[e(y,{modelValue:r.saleNumber,"onUpdate:modelValue":l[0]||(l[0]=t=>r.saleNumber=t),placeholder:"请输入销售单号",clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"药品名称"},{default:a(()=>[e(j,{modelValue:r.medicineId,"onUpdate:modelValue":l[1]||(l[1]=t=>r.medicineId=t),placeholder:"请选择药品",clearable:"",filterable:""},{default:a(()=>[(V(!0),M(J,null,K(N.value,t=>(V(),S(F,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(m,{label:"患者姓名"},{default:a(()=>[e(y,{modelValue:r.patientName,"onUpdate:modelValue":l[2]||(l[2]=t=>r.patientName=t),placeholder:"请输入患者姓名",clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"销售日期"},{default:a(()=>[e(E,{modelValue:g.value,"onUpdate:modelValue":l[3]||(l[3]=t=>g.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),e(m,null,{default:a(()=>[e(p,{type:"primary",onClick:Z},{default:a(()=>l[21]||(l[21]=[d("查询")])),_:1,__:[21]}),e(p,{onClick:ee},{default:a(()=>l[22]||(l[22]=[d("重置")])),_:1,__:[22]})]),_:1})]),_:1},8,["model"]),Ce((V(),S(ue,{data:q.value,style:{width:"100%"}},{default:a(()=>[e(c,{prop:"id",label:"销售ID",width:"80"}),e(c,{prop:"saleNumber",label:"销售单号",width:"120"}),e(c,{label:"药品名称",width:"150"},{default:a(t=>[d(s(A(t.row.medicineId)),1)]),_:1}),e(c,{prop:"quantity",label:"数量",width:"80"}),e(c,{prop:"unit",label:"单位",width:"80"}),e(c,{prop:"salePrice",label:"售价",width:"100"}),e(c,{prop:"totalAmount",label:"总金额",width:"100"}),e(c,{prop:"patientName",label:"患者姓名",width:"120"}),e(c,{prop:"saleTime",label:"销售时间",width:"180"}),e(c,{prop:"operatorName",label:"操作人",width:"100"}),e(c,{prop:"status",label:"状态",width:"100"},{default:a(t=>[e(Y,{type:t.row.status===1?"success":"danger"},{default:a(()=>[d(s(t.row.status===1?"正常":"已退货"),1)]),_:2},1032,["type"])]),_:1}),e(c,{label:"操作",width:"120",fixed:"right"},{default:a(t=>[t.row.status===1?(V(),S(p,{key:0,type:"danger",link:"",onClick:ce=>de(t.row)},{default:a(()=>l[23]||(l[23]=[d("退货")])),_:2,__:[23]},1032,["onClick"])):De("",!0),e(p,{type:"primary",link:"",onClick:ce=>ne(t.row)},{default:a(()=>l[24]||(l[24]=[d("详情")])),_:2,__:[24]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[pe,U.value]]),e(ie,{"current-page":r.current,"onUpdate:currentPage":l[4]||(l[4]=t=>r.current=t),"page-size":r.size,"onUpdate:pageSize":l[5]||(l[5]=t=>r.size=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:T.value,onSizeChange:le,onCurrentChange:ae},null,8,["current-page","page-size","total"])]),_:1}),e(Q,{modelValue:k.value,"onUpdate:modelValue":l[16]||(l[16]=t=>k.value=t),title:z.value,width:"800px",onClosed:B},{footer:a(()=>[e(p,{onClick:l[15]||(l[15]=t=>k.value=!1)},{default:a(()=>l[25]||(l[25]=[d("取消")])),_:1,__:[25]}),e(p,{type:"primary",onClick:re,loading:x.value},{default:a(()=>l[26]||(l[26]=[d("确定")])),_:1,__:[26]},8,["loading"])]),default:a(()=>[e(R,{ref_key:"formRef",ref:C,model:n,rules:W,"label-width":"100px"},{default:a(()=>[e(I,{gutter:20},{default:a(()=>[e(b,{span:12},{default:a(()=>[e(m,{label:"药品",prop:"medicineId"},{default:a(()=>[e(j,{modelValue:n.medicineId,"onUpdate:modelValue":l[6]||(l[6]=t=>n.medicineId=t),placeholder:"请选择药品",filterable:"",onChange:te},{default:a(()=>[(V(!0),M(J,null,K(N.value,t=>(V(),S(F,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(b,{span:12},{default:a(()=>[e(m,{label:"批次号",prop:"batchNumber"},{default:a(()=>[e(y,{modelValue:n.batchNumber,"onUpdate:modelValue":l[7]||(l[7]=t=>n.batchNumber=t),placeholder:"请输入批次号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(I,{gutter:20},{default:a(()=>[e(b,{span:12},{default:a(()=>[e(m,{label:"数量",prop:"quantity"},{default:a(()=>[e($,{modelValue:n.quantity,"onUpdate:modelValue":l[8]||(l[8]=t=>n.quantity=t),min:1,precision:0,onChange:P},null,8,["modelValue"])]),_:1})]),_:1}),e(b,{span:12},{default:a(()=>[e(m,{label:"单位",prop:"unit"},{default:a(()=>[e(y,{modelValue:n.unit,"onUpdate:modelValue":l[9]||(l[9]=t=>n.unit=t),placeholder:"请输入单位"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(I,{gutter:20},{default:a(()=>[e(b,{span:12},{default:a(()=>[e(m,{label:"售价",prop:"salePrice"},{default:a(()=>[e($,{modelValue:n.salePrice,"onUpdate:modelValue":l[10]||(l[10]=t=>n.salePrice=t),min:0,precision:2,step:.01,onChange:P},null,8,["modelValue"])]),_:1})]),_:1}),e(b,{span:12},{default:a(()=>[e(m,{label:"总金额"},{default:a(()=>[e(y,{modelValue:n.totalAmount,"onUpdate:modelValue":l[11]||(l[11]=t=>n.totalAmount=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(I,{gutter:20},{default:a(()=>[e(b,{span:12},{default:a(()=>[e(m,{label:"患者姓名",prop:"patientName"},{default:a(()=>[e(y,{modelValue:n.patientName,"onUpdate:modelValue":l[12]||(l[12]=t=>n.patientName=t),placeholder:"请输入患者姓名"},null,8,["modelValue"])]),_:1})]),_:1}),e(b,{span:12},{default:a(()=>[e(m,{label:"销售时间",prop:"saleTime"},{default:a(()=>[e(E,{modelValue:n.saleTime,"onUpdate:modelValue":l[13]||(l[13]=t=>n.saleTime=t),type:"datetime",placeholder:"选择日期时间"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(m,{label:"备注",prop:"remark"},{default:a(()=>[e(y,{modelValue:n.remark,"onUpdate:modelValue":l[14]||(l[14]=t=>n.remark=t),type:"textarea",rows:2,placeholder:"请输入备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(Q,{modelValue:D.value,"onUpdate:modelValue":l[18]||(l[18]=t=>D.value=t),title:"销售详情",width:"800px"},{footer:a(()=>[e(p,{onClick:l[17]||(l[17]=t=>D.value=!1)},{default:a(()=>l[27]||(l[27]=[d("关闭")])),_:1,__:[27]})]),default:a(()=>[e(me,{column:2,border:""},{default:a(()=>[e(f,{label:"销售ID"},{default:a(()=>[d(s(i.id),1)]),_:1}),e(f,{label:"销售单号"},{default:a(()=>[d(s(i.saleNumber),1)]),_:1}),e(f,{label:"药品名称"},{default:a(()=>[d(s(A(i.medicineId||0)),1)]),_:1}),e(f,{label:"批次号"},{default:a(()=>[d(s(i.batchNumber),1)]),_:1}),e(f,{label:"数量"},{default:a(()=>[d(s(i.quantity)+" "+s(i.unit),1)]),_:1}),e(f,{label:"售价"},{default:a(()=>[d(s(i.salePrice),1)]),_:1}),e(f,{label:"总金额"},{default:a(()=>[d(s(i.totalAmount),1)]),_:1}),e(f,{label:"患者姓名"},{default:a(()=>[d(s(i.patientName),1)]),_:1}),e(f,{label:"销售时间"},{default:a(()=>[d(s(i.saleTime),1)]),_:1}),e(f,{label:"操作人"},{default:a(()=>[d(s(i.operatorName),1)]),_:1}),e(f,{label:"状态"},{default:a(()=>[e(Y,{type:i.status===1?"success":"danger"},{default:a(()=>[d(s(i.status===1?"正常":"已退货"),1)]),_:1},8,["type"])]),_:1}),e(f,{label:"备注",span:2},{default:a(()=>[d(s(i.remark),1)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});const ze=Se(Te,[["__scopeId","data-v-c61c2ed9"]]);export{ze as default};
